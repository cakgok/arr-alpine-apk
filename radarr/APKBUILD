pkgname=radarr
pkgver=5.27.5.10198
pkgrel=0
pkgdesc="Movie collection manager (pre-built musl binary)"
url="https://radarr.video/"
arch="x86_64"
license="GPL-3.0-or-later"
depends="icu-libs ca-certificates tzdata lttng-ust"
makedepends="patchelf"
options="!check"
_arch="x64"
source="radarr-$pkgver-musl.tar.gz::https://github.com/Radarr/Radarr/releases/download/v${pkgver}/Radarr.master.${pkgver}.linux-musl-core-${_arch}.tar.gz"
builddir="$srcdir"

build() {
	:
}

package() {
	install -d "$pkgdir/usr/lib/$pkgname"
	cp -r "$srcdir/Radarr/." "$pkgdir/usr/lib/$pkgname/"

	# Radarr bundles its own liblttng-ust-comm which can cause conflicts.
	# Remove it to ensure it uses the system-provided version.
	rm -f "$pkgdir/usr/lib/$pkgname/liblttng-ust-comm.so"

	# The prebuilt binary is linked against the old liblttng-ust.so.0.
	# We must find all ELF files that have this dependency and patch them to
	# use liblttng-ust.so.1 provided by the newer package.
	# We use scanelf to identify only the files that need patching.
	find "$pkgdir/usr/lib/$pkgname" -type f -print0 | while IFS= read -r -d '' file; do
		# Check if the file is an ELF and needs the old library, silencing scanelf errors for non-ELF files
		if scanelf -q --needed "$file" 2>/dev/null | grep -q 'liblttng-ust.so.0'; then
			msg "Patching '$file' to use new lttng-ust soname"
			patchelf --replace-needed liblttng-ust.so.0 liblttng-ust.so.1 "$file"
		fi
	done

	install -Dm755 /dev/null "$pkgdir/usr/bin/$pkgname"
	cat > "$pkgdir/usr/bin/$pkgname" <<-EOF
		#!/usr/bin/env sh
		exec /usr/lib/$pkgname/Radarr "\$@"
	EOF
}

sha512sums="
8c12dda63c28205b194b2c9ecce9c6f51977503d32b48668d4014e5b7f8c4b5ff00ef52d9e8331855cd7db3e2198a03afc4fed96a3cf2ce5dfe2c1efc8c15b58  radarr-5.27.5.10198-musl.tar.gz
"
